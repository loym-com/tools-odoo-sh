#!/usr/bin/env bash

set -e

help-table() {
    local cmd_width=10
    local opt_width=6
    local desc_width=40
    local column="| %-${cmd_width}s | %-${opt_width}s | %-${desc_width}s |\n"
    printf "$column" "Command" "Option" "Description"
    echo "|$(printf '%*s' $((cmd_width + 2)) '' | tr ' ' '-')|$(printf '%*s' $((opt_width + 2)) '' | tr ' ' '-')|$(printf '%*s' $((desc_width + 2)) '' | tr ' ' '-')|"
    printf "$column" "help" "[grep]" "Show help for commands."
    printf "$column" "install" "" "Setup the local environment."
    printf "$column" "lint" "" "Run pre-commit and update index.html."
    printf "$column" "version" "" "Show version of required tools."
}

help-table() {
    local cmd_width=20
    local desc_width=50
    local column="| %-${cmd_width}s | %-${desc_width}s |\n"

    printf "$column" "Command" "Description"
    echo "|$(printf '%*s' $((cmd_width + 2)) '' | tr ' ' '-')|$(printf '%*s' $((desc_width + 2)) '' | tr ' ' '-')|"

    printf "$column" "help [grep]" "Show help for commands."
    printf "$column" "git_henrik" "Configure Henrik's global Git settings."
    printf "$column" "update" "Update all submodules and push Staging branch."
    printf "$column" "update_all_submodules" "Update all submodules recursively."
    printf "$column" "update_submodule <name>" "Update a single submodule."
    printf "$column" "add_submodule <user> <repo> <branch> [name] [path]" "Add a Git submodule."
    printf "$column" "add_module <submodule> <module>" "Symlink a module from a submodule."
    printf "$column" "remove_module <submodule> <module>" "Remove symlinked module."
    printf "$column" "remove_submodule <submodule>" "Remove a Git submodule."
    printf "$column" "add_beta_module <user> <repo> <branch> <module> <dir>" "Add a 'beta' module."
    printf "$column" "add_fix_module <user> <rrep> <branch> <module> <dir>" "Add a 'fix' module."
    printf "$column" "remove_beta_module <submodule> <module>" "Remove beta module + submodule."
    printf "$column" "remove_fix_module <submodule> <module>" "Remove fix module + submodule."
}

help() {
    echo
    if [[ -n "$1" ]]; then
        help-table | grep -i "$1" | column -t -s'|'
    else
        echo "task <command> [options]"
        echo
        echo "commands:"
        echo
        help-table
    fi
    echo
}

###########################################################

# DO FIRST TIME

git_henrik() {
    git config --global user.email "henrik@loym.com"
    git config --global user.name "Henrik Norlin"
    mkdir -p ~/.ssh
}

# UPDATE

update() {
    update_all_submodules
    git push --set-upstream origin Staging
}

update_all_submodules() {
    _do_first
    git submodule update --init --remote && \
    git commit -am "git submodule update"
}

update_submodule() {
    _do_first
    submodule=$1
    path="$(_get_submodule_path $submodule)"

    git submodule update --init --remote $path && \
    git commit -am "git submodule update $path"
}

# STANDARD

add_submodule() {
    _do_first
    gh_user=$1
    gh_repo=$2
    gh_branch=$3
    submodule_name="${4:-$(_get_default_submodule_name $gh_user $gh_repo)}"
    submodule_path="${5:-$(_get_default_submodule_path $submodule_name)}"
    url=$(_get_url $gh_user $gh_repo)

    git submodule add --name $submodule_name -b $gh_branch $url $submodule_path && \
    git add --all && \
    git commit -m "Added $submodule_path"
}

add_module() {
    _do_first
    submodule=$1
    module=$2
    path=$(_get_submodule_path $submodule)
    _check_submodule_path $path
    IFS='/' read -r dir1 dir2 dir3 <<< "$path"
    ln_link="$dir1/$dir2/$module"
    ln_target=$dir3/$module

    ln -s $ln_target $ln_link && \
    git add --all && \
    git commit -m "Added module $ln_link"
}

remove_module() {
    _do_first
    submodule=$1
    module=$2
    path=$(_get_submodule_path $submodule)
    _check_submodule_path $path
    IFS='/' read -r dir1 dir2 dir3 <<< "$path"
    ln_link="$dir1/$dir2/$module"

    rm $ln_link && \
    git add --all && \
    git commit -m "Removed module $ln_link"
}

remove_submodule() {
    _do_first
    submodule=$1
    path=$(_get_submodule_path $submodule)

    git submodule deinit -f "$path" && \
    git rm -f "$path" && \
    rm -rf ".git/modules/$path" && \
    git add --all && \
    git commit -m "Removed submodule $path"
}

# CUSTOM

add_beta_module() {
    # Lowest priority, replace with module in e.g. OCA.
    _add_custom_module "$@" "z-BETA"
}
add_fix_module() {
    # Highest priority, override module in e.g. OCA.
    _add_custom_module "$@" "A-FIX"
}
_add_custom_module() {
    gh_user=$1
    gh_repo=$2
    gh_branch=$3
    module=$4
    dir1=$5
    submodule_name=$(_get_default_submodule_name $dir1 $module)
    submodule_path=$(_get_default_submodule_path $dir1 $module)
    add_submodule $gh_user $gh_repo $gh_branch $submodule_name $submodule_path
    add_module $submodule_name $module $submodule_path
}

remove_beta_module() {
    _remove_custom_module "$@" "z-BETA"
}
remove_fix_module() {
    _remove_custom_module "$@" "A-FIX"
}
_remove_custom_module() {
    _do_first
    submodule=$1
    module=$2
    remove_module $submodule $module
    remove_submodule $submodule
}

# LOW-LEVEL

_do_first() {
    chmod 600 ~/.ssh/id_ed25519
    eval "$(ssh-agent -s)"
    ssh-add ~/.ssh/id_ed25519
    cd ~/src/user
    git checkout Staging
}

_get_url() {
    gh_user=$1
    gh_repo=$2
    echo "git@github.com:$gh_user/$gh_repo.git"
}

_get_default_submodule_name() {
    dir1=$1
    dir2=$2
    echo "$dir1/$dir2"
}

_get_default_submodule_path() {
    dir1=$1
    dir2=$2
    echo "$dir1/$dir2/.$dir2"
}

_get_submodule_path() {
    submodule=$1
    path=$(git config --file .gitmodules --get "submodule.${$submodule}.path")
    echo "$path"
}

_check_submodule_path() {
    submodule=$1
    path=$(_get_submodule_path $submodule)
    IFS='/' read -r dir1 dir2 dir3 <<< "$path"
    if [[ $dir3 != .* ]]; then
        echo "Error: Submodule path $path: dir3 must begin with a dot" >&2
        exit 1
    fi
}

###########################################################

if declare -f "$1" > /dev/null; then
    "$1" "${@:2}"
else
    case "$1" in
        all)
            install
            lint
            ;;
        *)
            echo "Unknown command: $1"
            help
            exit 1
            ;;
    esac
fi
